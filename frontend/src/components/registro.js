import React, { useState } from "react";
import { useNavigate } from "react-router-dom";
import { GoogleLogin } from "@react-oauth/google";
import "../registro.css";
import ActivarCuenta from "./ActivarCuenta";

const Register = () => {
  const navigate = useNavigate();
  const [formData, setFormData] = useState({
    nombre: "",
    apellido_paterno: "",
    apellido_materno: "",
    correo: "",
    contrase√±a: "",
    confirmarContrase√±a: "",
    telefono: "",
    pregunta_secreta: "",
    respuesta: "",
  });

  const [codigoOTP, setCodigoOTP] = useState("");
  const [showOTPForm, setShowOTPForm] = useState(false);
  const [message, setMessage] = useState("");
  const [correoParaActivar, setCorreoParaActivar] = useState(null);
  const [fieldErrors, setFieldErrors] = useState({});

  // Mostrar / ocultar contrase√±as
  const [showPassword, setShowPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);

  const preguntas = [
    "¬øCu√°l es el nombre de tu primera mascota?",
    "¬øCu√°l es tu ciudad natal?",
    "¬øCu√°l es tu comida favorita?"
  ];

  // Validaciones espec√≠ficas para cada campo
  const validations = {
    nombre: {
      required: true,
      pattern: /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/,
      message: "El nombre solo puede contener letras y espacios"
    },
    apellido_paterno: {
      required: true,
      pattern: /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/,
      message: "El apellido paterno solo puede contener letras y espacios"
    },
    apellido_materno: {
      required: false,
      pattern: /^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]*$/,
      message: "El apellido materno solo puede contener letras y espacios"
    },
    correo: {
      required: true,
      pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
      message: "Por favor, introduce un correo electr√≥nico v√°lido"
    },
    contrase√±a: {
      required: true,
      pattern: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/,
      message: "La contrase√±a debe tener al menos 8 caracteres, una may√∫scula, una min√∫scula, un n√∫mero y un car√°cter especial"
    },
    confirmarContrase√±a: {
      required: true,
      validate: (value, formData) => value === formData.contrase√±a,
      message: "Las contrase√±as no coinciden"
    },
    telefono: {
      required: true,
      pattern: /^[0-9]{10}$/,
      message: "El tel√©fono debe tener 10 d√≠gitos"
    },
    pregunta_secreta: {
      required: true,
      message: "Por favor, selecciona una pregunta secreta"
    },
    respuesta: {
      required: true,
      message: "Por favor, proporciona una respuesta a tu pregunta secreta"
    }
  };

  // Funci√≥n de validaci√≥n de campo individual
  const validateField = (name, value, formData) => {
    const validation = validations[name];
    if (!validation) return null;
    
    if (validation.required && !value.trim()) {
      return "Este campo es obligatorio";
    }
    
    if (validation.pattern && value && !validation.pattern.test(value)) {
      return validation.message;
    }
    
    if (validation.validate && !validation.validate(value, formData)) {
      return validation.message;
    }
    
    return null;
  };

  // Validaci√≥n completa del formulario
  const validateForm = (formData) => {
    const errors = {};
    let isValid = true;
    
    Object.keys(validations).forEach(field => {
      const error = validateField(field, formData[field], formData);
      if (error) {
        errors[field] = error;
        isValid = false;
      }
    });
    
    return { isValid, errors };
  };

  const handleChange = (e) => {
    const { name, value } = e.target;
    setFormData({ ...formData, [name]: value });
    
    // Validaci√≥n en tiempo real y limpiar error del campo
    if (fieldErrors[name]) {
      const error = validateField(name, value, formData);
      setFieldErrors({
        ...fieldErrors,
        [name]: error
      });
    }
  };

  
  const addShakeEffect = (fieldName) => {
    const field = document.querySelector(`[name="${fieldName}"]`);
    if (field) {
      field.classList.add('shake');
      setTimeout(() => field.classList.remove('shake'), 500);
    }
  };

  // Registro tradicional con validaci√≥n
  const handleRegister = async () => {
    const { isValid, errors } = validateForm(formData);
    
    if (!isValid) {
      setFieldErrors(errors);
      // Aplicar efecto shake a todos los campos con error
      Object.keys(errors).forEach(fieldName => {
        addShakeEffect(fieldName);
      });
      setMessage("Por favor, corrige los errores en el formulario");
      return;
    }

    // Si la validaci√≥n es exitosa, proceder con el registro
    try {
      const res = await fetch("https://novagraf-production.up.railway.app/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData),
      });
      const data = await res.json();
      setMessage(data.message);

      if (res.status === 201) {
        setCorreoParaActivar(formData.correo);
        setFieldErrors({}); // Limpiar errores al √©xito
      } else {
        // Si hay error del servidor, mostrar mensaje
        setMessage(data.message || "Error en el registro");
      }
    } catch (error) {
      console.error("Error al registrar:", error);
      setMessage("Error de conexi√≥n con el servidor");
    }
  };

  // Registro con Google
  const handleGoogleRegister = async (credentialResponse) => {
    if (!credentialResponse || !credentialResponse.credential) {
      setMessage("No se recibi√≥ token de Google");
      return;
    }

    try {
      const res = await fetch("https://novagraf-production.up.railway.app/api/auth/google-register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: credentialResponse.credential }),
      });

      const data = await res.json();
      setMessage(data.message);

      if (res.status === 200) {
        setTimeout(() => navigate("/login"), 2000);
      }
    } catch (error) {
      console.error("Error al registrar con Google:", error);
      setMessage("Error de conexi√≥n con el servidor");
    }
  };

  // Funci√≥n para obtener clase CSS seg√∫n validaci√≥n
  const getFieldClassName = (fieldName) => {
    if (fieldErrors[fieldName]) {
      return "error";
    }
    if (formData[fieldName] && !fieldErrors[fieldName]) {
      return "valid";
    }
    return "";
  };

  return (
    <div className="register-container">
      {!correoParaActivar ? (
        <div className="form-group">
          <div className="input-group">
            <input 
              name="nombre" 
              placeholder="Nombre" 
              onChange={handleChange}
              className={getFieldClassName("nombre")}
            />
            {fieldErrors.nombre && <span className="field-error">{fieldErrors.nombre}</span>}
          </div>

          <div className="input-group">
            <input 
              name="apellido_paterno" 
              placeholder="Apellido Paterno" 
              onChange={handleChange}
              className={getFieldClassName("apellido_paterno")}
            />
            {fieldErrors.apellido_paterno && <span className="field-error">{fieldErrors.apellido_paterno}</span>}
          </div>

          <div className="input-group">
            <input 
              name="apellido_materno" 
              placeholder="Apellido Materno" 
              onChange={handleChange}
              className={getFieldClassName("apellido_materno")}
            />
            {fieldErrors.apellido_materno && <span className="field-error">{fieldErrors.apellido_materno}</span>}
          </div>

          <div className="input-group">
            <input 
              name="correo" 
              placeholder="Correo" 
              onChange={handleChange}
              className={getFieldClassName("correo")}
            />
            {fieldErrors.correo && <span className="field-error">{fieldErrors.correo}</span>}
          </div>

          <div className="input-group">
            <div className="password-wrapper">
              <input
                type={showPassword ? "text" : "password"}
                name="contrase√±a"
                placeholder="Contrase√±a"
                onChange={handleChange}
                className={getFieldClassName("contrase√±a")}
              />
              <span className="toggle-password" onClick={() => setShowPassword(!showPassword)}>
                {showPassword ? "üôà" : "üëÅÔ∏è"}
              </span>
            </div>
            {fieldErrors.contrase√±a && <span className="field-error">{fieldErrors.contrase√±a}</span>}
          </div>

          <div className="input-group">
            <div className="password-wrapper">
              <input
                type={showConfirmPassword ? "text" : "password"}
                name="confirmarContrase√±a"
                placeholder="Confirmar Contrase√±a"
                onChange={handleChange}
                className={getFieldClassName("confirmarContrase√±a")}
              />
              <span className="toggle-password" onClick={() => setShowConfirmPassword(!showConfirmPassword)}>
                {showConfirmPassword ? "üôà" : "üëÅÔ∏è"}
              </span>
            </div>
            {fieldErrors.confirmarContrase√±a && <span className="field-error">{fieldErrors.confirmarContrase√±a}</span>}
          </div>

          <div className="input-group">
            <input 
              name="telefono" 
              placeholder="Tel√©fono" 
              onChange={handleChange}
              className={getFieldClassName("telefono")}
            />
            {fieldErrors.telefono && <span className="field-error">{fieldErrors.telefono}</span>}
          </div>

          <div className="input-group">
            <select 
              name="pregunta_secreta" 
              onChange={handleChange}
              className={getFieldClassName("pregunta_secreta")}
            >
              <option value="">-- Selecciona tu pregunta secreta --</option>
              {preguntas.map((p, i) => (
                <option key={i} value={p}>{p}</option>
              ))}
            </select>
            {fieldErrors.pregunta_secreta && <span className="field-error">{fieldErrors.pregunta_secreta}</span>}
          </div>

          <div className="input-group">
            <input 
              name="respuesta" 
              placeholder="Respuesta" 
              onChange={handleChange}
              className={getFieldClassName("respuesta")}
            />
            {fieldErrors.respuesta && <span className="field-error">{fieldErrors.respuesta}</span>}
          </div>

          <button onClick={handleRegister}>Registrarse</button>

          <p className="register-link">
            ¬øYa tienes cuenta?{" "}
            <span onClick={() => navigate("/login")}>Iniciar Sesi√≥n</span>
          </p>
          <hr />
          <div className="google-login-container">
            <GoogleLogin onSuccess={handleGoogleRegister} onError={() => setMessage("Error Google Sign-In")} />
          </div>
        </div>
      ) : (
        <ActivarCuenta correo={correoParaActivar} />
      )}

      {message && <p className={`message ${message.includes("Error") ? "error" : "success"}`}>{message}</p>}
    </div>
  );
};

export default Register;